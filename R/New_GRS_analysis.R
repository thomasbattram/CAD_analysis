# ----------------------------------------------------------------------------
# New GRS analysis 
# ----------------------------------------------------------------------------

# Read in variants 
#sig_SNPs <- read.delim(paste0("outputs/other/", as.character(age), "/significant_SNPs.txt"), stringsAsFactors = F, header = F)
sig_SNPs <- read.delim(paste0("outputs/other/", as.character(age), "/FDR_significant_SNPs.txt"), stringsAsFactors = F, header = F)
sig_SNPs <- paste(sig_SNPs[[1]], "_w", sep = "")
non_sig_SNPs <- SNPs[!(SNPs %in% sig_SNPs)]

# Produce a score based on SNPs that associated with 1 or more metabolite
d[["metabo_GRS"]] <- rowSums(d[, sig_SNPs])
# Produce a score based on SNPs that didn't associate with any metabolites
d[["residual_GRS"]] <- rowSums(d[, non_sig_SNPs])

metabo_GRS_lr_nr <- linearRegress('metabo_GRS', nr_mnames, d, "age")

residual_GRS_lr_nr <- linearRegress('residual_GRS', nr_mnames, d, "age")

if (!(exists("CAD_score_lr_nr"))) {
  d[["CAD_score"]] <- rowSums(d[, SNPs])
  CAD_score_lr_nr <- linearRegress('CAD_score', nr_mnames, d, "age")
}

# ------------------------------------------------------------------
# Variance explained by the variants associated with 1 or more metabolites
# ------------------------------------------------------------------
linearRegress2 <- function(exposure.name,metabolite.name,dataset,covariate.name=NULL,  
                        metabolite.log='F',subset=NULL) 
{ 
  ## exposure.name: the single exposure, e.g. 'BMI' - in this case the SNP or score 
  ## metabolite.name: multiple metabolic outcomes, e.g. c('LDL_C','SERUM_TG') 
  
  tx <- dataset
  if(!is.null(subset)) {ind = with(tx, eval(parse(text = subset))); tx = tx[ind, ]} 
  
  ## linear regression of exposure with metabolites      
  add <- numeric() 
  fom <- formula(paste('met~', paste(c(exposure.name, covariate.name),collapse = '+'))) 
  
  for (j in 1:length(metabolite.name))  
  { 
    met <- tx[[metabolite.name[j]]];    
    fit <- lm(fom, data = tx) 
    temp <- c(summary(fit)$coef[exposure.name, ], confint(fit)[exposure.name, ], summary(fit)$r.squared); 
    add <- rbind(add,temp);  
  }   
  rownames(add) <- metabolite.name 
  add <- data.frame(add,check.names = F) 
  add$Metabolite <- metabolite.name
  add 
}

metabo_GRS_lr_nr2 <- linearRegress2('metabo_GRS', nr_mnames, d, "age")
metabo_GRS_lr_nr2 <- arrange(metabo_GRS_lr_nr2, Metabolite)
head(metabo_GRS_lr_nr2)
summary(metabo_GRS_lr_nr2)
CAD_score_lr_nr2 <- linearRegress2('CAD_score', nr_mnames, d, "age")
CAD_score_lr_nr2 <- arrange(CAD_score_lr_nr2, Metabolite)
head(CAD_score_lr_nr2)
summary(CAD_score_lr_nr2)


CAD_score_lr_nr2$r2_ratio <- metabo_GRS_lr_nr2$V7/CAD_score_lr_nr2$V7
summary(CAD_score_lr_nr2)



# ----------------------------------------------------------------------------
# Plots
# ----------------------------------------------------------------------------

# Forest 
source("R/Forest_plot_functions.R")
residual_GRS_lr_nr <- arrange(residual_GRS_lr_nr, Metabolite)
metabo_GRS_lr_nr <- arrange(metabo_GRS_lr_nr, Metabolite)
CAD_score_lr_nr <- arrange(CAD_score_lr_nr, Metabolite)
stopifnot(nrow(CAD_score_lr_nr) == nrow(metabo_GRS_lr_nr) && nrow(CAD_score_lr_nr) == nrow(metabo_GRS_lr_nr))

facet_var <- facet_var_gen(CAD_score_lr_nr, col_num = 4, group_num = 3)
forest_dat <- rbind(CAD_score_lr_nr[, 1:7], metabo_GRS_lr_nr, residual_GRS_lr_nr) %>%
  mutate(score = rep(c("Total", "Metabolite", "Residual"), each = nrow(CAD_score_lr_nr))) %>%
  mutate(facet_var = facet_var)


forest_dat[["facet_var"]] <- as.factor(forest_dat[["facet_var"]])
forest_dat$score <- as.factor(forest_dat$score)
pdf(paste0("outputs/forests/", as.character(age), "/all_scores_nrmetabs_forest.pdf"), width = 15, height = 10)
print(forest_plot(forest_dat, col_num = 4, group = "score", y_axis = "Metabolite", units = "Beta coefficient (95% CI)", null_at = 0))
dev.off()

# QQ 
res_out <- cbind(CAD_score_lr_nr, metabo_GRS_lr_nr$`Pr(>|t|)`, residual_GRS_lr_nr$`Pr(>|t|)`)
colnames(res_out)[colnames(res_out) %in% c("metabo_GRS_lr_nr$`Pr(>|t|)`", "residual_GRS_lr_nr$`Pr(>|t|)`")] <- c("sig_P", "non_sig_P")
res_out <- res_out %>%
  mutate(exp_p = (1:nrow(.))/(nrow(.)+1)) %>%
  mutate(x = -log10(exp_p)) %>%
  mutate(y.CAD = -log10(sort(`Pr(>|t|)`))) %>%
  mutate(y.sig = -log10(sort(sig_P))) %>%
  mutate(y.non_sig = -log10(sort(non_sig_P)))

l <- list(estlambda(res_out$`Pr(>|t|)`), estlambda(res_out$sig_P), estlambda(res_out$non_sig_P))
nom <- paste("CAD scores vs. all metabolites", "\n", "number of tests = ", nrow(res_out), "\nTotal score: lambda = ", round(l[[1]]$estimate, 3), ", se = ", round(l[[1]]$se, 3), "\nsig score: lambda = ", round(l[[2]]$estimate, 3), ", se = ", round(l[[2]]$se, 3), "\nNon-sig score: lambda = ", round(l[[3]]$estimate, 3), ", se = ", round(l[[3]]$se, 3), sep = "")
p <- ggplot(res_out, aes(x = x, y = y.CAD)) +
  geom_point(aes(colour = "Total GRS (56 variants)")) +
  geom_point(aes(x = x, y = y.sig, colour = "Metabolite GRS (7 variants)")) +
  geom_point(aes(x = x, y = y.non_sig, colour = "Residual GRS (49 variants)")) +
  geom_abline(slope = 1, intercept = 0, colour = "red") +
  scale_colour_discrete(breaks = c("Metabolite GRS (7 variants)", "Total GRS (56 variants)", "Residual GRS (49 variants)")) +
  #ggtitle(nom) +
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 30), legend.text = element_text(size = 20)) +
  labs(x = expression(Expected ~ ~-log[10](P)), y = expression(Observed ~ ~-log[10](P)), colour = "Genetic risk score")
pdf(paste0("outputs/other/", as.character(age), "/3_scores_vs_metabs_qq.pdf"), width = 20, height = 10)
print(p)
dev.off()

# ----------------------------------------------------------------------------
# Association tests 
# ----------------------------------------------------------------------------
metabo_GRS_assoc <- metabo_GRS_lr_nr %>%
  mutate(Bonferroni = p.adjust(`Pr(>|t|)`, method = "bonferroni")) %>%
  mutate(FDR = p.adjust(`Pr(>|t|)`, method = "fdr")) %>%
  filter(FDR < 0.05)

summary(metabo_GRS_lr_nr)
median(abs(metabo_GRS_lr_nr$Estimate))
median(abs(CAD_score_lr_nr$Estimate))

metabo_and_CAD <- rbind(metabo_GRS_lr_nr, CAD_score_lr_nr[, 1:7]) %>%
  mutate(score = rep(c("metabo", "CAD"), each = length(nr_mnames)))

wt <- wilcox.test(Estimate ~ score, data = metabo_and_CAD)
wt # P = 1.374e-13

residual_GRS_assoc <- residual_GRS_lr_nr %>%
  mutate(Bonferroni = p.adjust(`Pr(>|t|)`, method = "bonferroni")) %>%
  mutate(FDR = p.adjust(`Pr(>|t|)`, method = "fdr")) %>%
  filter(FDR < 0.05)

print("New GRS analysis complete, please move onto HMGCR_SNP_analysis")




